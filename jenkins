pipeline {
    agent any

    environment {
        SECONDARY_GIT_REPO = 'https://github.com/mdn/beginner-html-site-styled.git'
        BRANCH = 'main'
        DEPLOY_PATH = '/home/ubuntu/'
        SSH_USER = 'ubuntu'
        SSH_HOST = '13.232.235.42'
    }

    stages {
        stage('Trigger on Webhook') {
            // This stage is implicit and triggered by webhook configured in Jenkins
            steps {
                echo 'Triggered by webhook...'
            }
        }

        stage('Fetch Code from Secondary Repository') {
            steps {
                echo 'Fetching code from secondary repository...'
                // Clone the secondary repository
                dir('secondary_repo') {
                    git branch: "${BRANCH}", url: "${SECONDARY_GIT_REPO}"
                }
            }
        }

        stage('Deploy to EC2 Instance') {
            steps {
                echo 'Deploying code to EC2 instance...'
                // Transfer the cloned repository to the EC2 instance
                sh """
                scp -r secondary_repo ${SSH_USER}@${SSH_HOST}:${DEPLOY_PATH}
                """
            }
        }
    }

    post {
        always {
            echo 'Cleaning up workspace...'
            cleanWs()
        }
        success {
            echo 'Pipeline completed successfully!'
        }
        failure {
            echo 'Pipeline failed!'
        }
    }
}
